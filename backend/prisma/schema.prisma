generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model CUSTOMER_MEMOS {
  @@map("CUSTOMER_MEMOS")
  memo_id     BigInt    @id @default(autoincrement())
  user_id     BigInt
  writer_id   BigInt
  shop_id     BigInt
  content     String    @db.Text
  tags        String?   @db.VarChar(255)
  created_at  DateTime? @default(now()) @db.DateTime(0)
  SHOPS       SHOPS     @relation(fields: [shop_id], references: [shop_id], onDelete: Cascade, onUpdate: Restrict)
  target_user USERS     @relation("TargetUserMemos", fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)
  writer      USERS     @relation("WriterMemos", fields: [writer_id], references: [user_id], onUpdate: Restrict)

  @@index([shop_id], map: "shop_id")
  @@index([user_id], map: "user_id")
  @@index([writer_id], map: "CUSTOMER_MEMOS_writer_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model DESIGNERS {
  @@map("DESIGNERS")
  designer_id     BigInt            @id @default(autoincrement())
  user_id         BigInt            // Removed @unique to allow multi-shop designers
  shop_id         BigInt
  intro_text      String?           @db.Text
  profile_img     String?           @db.VarChar(255)
  work_start      DateTime?         @db.Time(0)
  work_end        DateTime?         @db.Time(0)
  lunch_start     DateTime?         @db.Time(0)
  lunch_end       DateTime?         @db.Time(0)
  day_off         String?           @db.VarChar(50)
  is_active       Boolean?          @default(true)
  USERS           USERS             @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)
  SHOPS           SHOPS             @relation(fields: [shop_id], references: [shop_id], onUpdate: Restrict)
  RESERVATIONS    RESERVATIONS[]
  SCHEDULE_BLOCKS SCHEDULE_BLOCKS[]
  VISIT_LOGS      VISIT_LOGS[]

  @@index([shop_id], map: "DESIGNERS_shop_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model MENUS {
  @@map("MENUS")
  menu_id           BigInt              @id @default(autoincrement())
  shop_id           BigInt
  category          String?             @db.VarChar(50) // Deprecated: use category_id
  category_id       BigInt?
  name              String              @db.VarChar(100)
  price             Int                 @default(0)
  duration          Int                 @default(60)
  description       String?             @db.Text
  thumbnail_url     String?             @db.VarChar(255)
  is_deleted        Boolean?            @default(false)
  type              MENUS_type          @default(MENU)
  sort_order        Int                 @default(0)
  SHOPS             SHOPS               @relation(fields: [shop_id], references: [shop_id], onDelete: Cascade, onUpdate: Restrict)
  parent            MENUS?              @relation("CategoryParent", fields: [category_id], references: [menu_id], onDelete: SetNull, onUpdate: Restrict)
  children          MENUS[]             @relation("CategoryParent")
  RESERVATION_ITEMS RESERVATION_ITEMS[]

  @@index([shop_id], map: "MENUS_shop_id_fkey")
  @@index([category_id], map: "MENUS_category_id_fkey")
}

enum MENUS_type {
  MENU
  CATEGORY
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model PAYMENTS {
  @@map("PAYMENTS")
  payment_id     BigInt          @id @default(autoincrement())
  reservation_id BigInt
  type           PAYMENTS_type
  amount         Int
  status         PAYMENTS_status @default(PAID)
  paid_at        DateTime?       @default(now()) @db.DateTime(0)
  RESERVATIONS   RESERVATIONS    @relation(fields: [reservation_id], references: [reservation_id], onDelete: Cascade, onUpdate: Restrict)
  PREPAID_TRANSACTIONS PREPAID_TRANSACTIONS[]

  @@index([reservation_id], map: "PAYMENTS_reservation_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model RESERVATIONS {
  @@map("RESERVATIONS")
  reservation_id    BigInt              @id @default(autoincrement())
  shop_id           BigInt
  customer_id       BigInt
  designer_id       BigInt
  start_time        DateTime            @db.DateTime(0)
  end_time          DateTime            @db.DateTime(0)
  status            RESERVATIONS_status @default(PENDING)
  request_memo      String?             @db.Text
  alarm_enabled     Boolean?            @default(true)
  source            RESERVATIONS_source @default(ADMIN)
  created_at        DateTime?           @default(now()) @db.DateTime(0)
  PAYMENTS          PAYMENTS[]
  USERS             USERS               @relation(fields: [customer_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)
  DESIGNERS         DESIGNERS           @relation(fields: [designer_id], references: [designer_id], onDelete: Cascade, onUpdate: Restrict)
  SHOPS             SHOPS               @relation(fields: [shop_id], references: [shop_id], onDelete: Cascade, onUpdate: Restrict)
  RESERVATION_ITEMS RESERVATION_ITEMS[]
  VISIT_LOGS        VISIT_LOGS?

  @@index([customer_id], map: "RESERVATIONS_customer_id_fkey")
  @@index([designer_id], map: "RESERVATIONS_designer_id_fkey")
  @@index([shop_id], map: "RESERVATIONS_shop_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model RESERVATION_ITEMS {
  @@map("RESERVATION_ITEMS")
  item_id        BigInt       @id @default(autoincrement())
  reservation_id BigInt
  menu_id        BigInt?
  menu_name      String       @db.VarChar(100)
  price          Int
  MENUS          MENUS?       @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade, onUpdate: Restrict)
  RESERVATIONS   RESERVATIONS @relation(fields: [reservation_id], references: [reservation_id], onDelete: Cascade, onUpdate: Restrict)

  @@index([menu_id], map: "RESERVATION_ITEMS_menu_id_fkey")
  @@index([reservation_id], map: "RESERVATION_ITEMS_reservation_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model SCHEDULE_BLOCKS {
  @@map("SCHEDULE_BLOCKS")
  block_id    BigInt               @id @default(autoincrement())
  designer_id BigInt
  start_time  DateTime             @db.DateTime(0)
  end_time    DateTime             @db.DateTime(0)
  type        SCHEDULE_BLOCKS_type
  reason      String?              @db.VarChar(255)
  DESIGNERS   DESIGNERS            @relation(fields: [designer_id], references: [designer_id], onDelete: Cascade, onUpdate: Restrict)

  @@index([designer_id], map: "SCHEDULE_BLOCKS_designer_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model SHOPS {
  @@map("SHOPS")
  shop_id            BigInt           @id @default(autoincrement())
  owner_id           BigInt
  name               String           @db.VarChar(100)
  tel                String?          @db.VarChar(20)
  address            String?          @db.VarChar(255)
  settlement_bank    String?          @db.VarChar(50)
  settlement_account String?          @db.VarChar(50)
  open_time          DateTime?        @default(dbgenerated("('10:00:00')")) @db.Time(0)
  close_time         DateTime?        @default(dbgenerated("('20:00:00')")) @db.Time(0)
  created_at         DateTime?        @default(now()) @db.DateTime(0)
  closed_days        String?          @db.VarChar(50)
  CUSTOMER_MEMOS     CUSTOMER_MEMOS[]
  DESIGNERS          DESIGNERS[]
  MENUS              MENUS[]
  RESERVATIONS       RESERVATIONS[]
  PREPAID_TICKETS    PREPAID_TICKETS[]
  CUSTOMER_PREPAID_BALANCES CUSTOMER_PREPAID_BALANCES[]
  USERS              USERS            @relation(fields: [owner_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)

  @@index([owner_id], map: "SHOPS_owner_id_fkey")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model USERS {
  @@map("USERS")
  user_id           BigInt           @id @default(autoincrement())
  firebase_uid      String?          @unique(map: "firebase_uid") @db.VarChar(128)
  phone             String           @unique(map: "phone") @db.VarChar(20)
  email             String?          @unique(map: "email") @db.VarChar(100)
  password          String?          @db.VarChar(255)
  name              String           @db.VarChar(50)
  role              USERS_role       @default(CUSTOMER)
  gender            USERS_gender?
  birthdate         String?          @db.VarChar(8)
  is_app_user       Boolean?         @default(false)
  grade             USERS_grade?     @default(NEW)
  current_hashed_refresh_token String? @db.VarChar(255) // For Refresh Token Rotation
  created_at        DateTime?        @default(now()) @db.DateTime(0)
  target_user_memos CUSTOMER_MEMOS[] @relation("TargetUserMemos")
  writer_memos      CUSTOMER_MEMOS[] @relation("WriterMemos")
  DESIGNERS         DESIGNERS[]
  RESERVATIONS      RESERVATIONS[]
  SHOPS             SHOPS[]
  VISIT_LOGS        VISIT_LOGS[]
  CUSTOMER_PREPAID_BALANCES CUSTOMER_PREPAID_BALANCES[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model VISIT_LOGS {
  @@map("VISIT_LOGS")
  log_id         BigInt       @id @default(autoincrement())
  customer_id    BigInt
  reservation_id BigInt       @unique(map: "reservation_id")
  designer_id    BigInt
  admin_memo     String?      @db.Text
  photo_urls     String?      @db.LongText
  visited_at     DateTime?    @default(now()) @db.DateTime(0)
  USERS          USERS        @relation(fields: [customer_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)
  DESIGNERS      DESIGNERS    @relation(fields: [designer_id], references: [designer_id], onDelete: Cascade, onUpdate: Restrict)
  RESERVATIONS   RESERVATIONS @relation(fields: [reservation_id], references: [reservation_id], onDelete: Cascade, onUpdate: Restrict)

  @@index([customer_id], map: "VISIT_LOGS_customer_id_fkey")
  @@index([designer_id], map: "VISIT_LOGS_designer_id_fkey")
}

enum PAYMENTS_type {
  APP_DEPOSIT
  SITE_CARD
  SITE_CASH
  PREPAID
}

enum SCHEDULE_BLOCKS_type {
  LUNCH
  OFF
  PERSONAL
  HOLIDAY
}

enum PAYMENTS_status {
  PAID
  REFUNDED
  FAILED
}

enum USERS_role {
  CUSTOMER
  DESIGNER
  OWNER
  ADMIN
}

enum RESERVATIONS_status {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELED
  NOSHOW
}

enum RESERVATIONS_source {
  ADMIN
  APP
  NAVER
  KAKAO
}

enum USERS_gender {
  MALE
  FEMALE
}

enum USERS_grade {
  NEW
  VIP
  CAUTION
}

model PREPAID_TICKETS {
  @@map("PREPAID_TICKETS")
  ticket_id     BigInt    @id @default(autoincrement())
  shop_id       BigInt
  name          String    @db.VarChar(100)
  price         Int
  credit_amount Int
  validity_days Int?
  is_active     Boolean?  @default(true)
  created_at    DateTime? @default(now()) @db.DateTime(0)
  SHOPS         SHOPS     @relation(fields: [shop_id], references: [shop_id], onDelete: Cascade, onUpdate: Restrict)

  @@index([shop_id], map: "PREPAID_TICKETS_shop_id_fkey")
}

model CUSTOMER_PREPAID_BALANCES {
  @@map("CUSTOMER_PREPAID_BALANCES")
  balance_id   BigInt    @id @default(autoincrement())
  user_id      BigInt
  shop_id      BigInt
  balance      Int       @default(0)
  last_used_at DateTime? @db.DateTime(0)
  created_at   DateTime? @default(now()) @db.DateTime(0)
  USERS        USERS     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: Restrict)
  SHOPS        SHOPS     @relation(fields: [shop_id], references: [shop_id], onDelete: Cascade, onUpdate: Restrict)
  PREPAID_TRANSACTIONS PREPAID_TRANSACTIONS[]

  @@unique([user_id, shop_id], map: "user_shop_unique")
  @@index([user_id], map: "CUSTOMER_PREPAID_BALANCES_user_id_fkey")
  @@index([shop_id], map: "CUSTOMER_PREPAID_BALANCES_shop_id_fkey")
}

model PREPAID_TRANSACTIONS {
  @@map("PREPAID_TRANSACTIONS")
  transaction_id BigInt                    @id @default(autoincrement())
  balance_id     BigInt
  type           PREPAID_TRANSACTIONS_type
  amount         Int
  bonus_amount   Int?                      @default(0)
  balance_after  Int
  ref_payment_id BigInt?
  created_at     DateTime?                 @default(now()) @db.DateTime(0)
  payment_method String?                   @default("CASH") @db.VarChar(20) // 'CARD', 'CASH'
  CUSTOMER_PREPAID_BALANCES CUSTOMER_PREPAID_BALANCES @relation(fields: [balance_id], references: [balance_id], onDelete: Cascade, onUpdate: Restrict)
  PAYMENTS                  PAYMENTS?                 @relation(fields: [ref_payment_id], references: [payment_id], onDelete: SetNull, onUpdate: Restrict)

  @@index([balance_id], map: "PREPAID_TRANSACTIONS_balance_id_fkey")
  @@index([ref_payment_id], map: "PREPAID_TRANSACTIONS_ref_payment_id_fkey")
}

enum PREPAID_TRANSACTIONS_type {
  CHARGE
  USE
  REFUND
  EXPIRE
  ADJUST
}
