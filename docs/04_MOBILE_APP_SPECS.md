# 04. 모바일 앱 기능 정의서 (Mobile App Specs)

## 1. 개요 (Overview)
본 문서는 **Salon Manager** 서비스의 일반 고객(Customer)용 모바일 애플리케이션(Android)의 기능 및 요구사항을 정의한다.
고객은 이 앱을 통해 매장을 조회하고, 디자이너와 시술 메뉴를 선택하여 예약을 진행하며, 본인의 예약 내역과 시술 히스토리를 관리할 수 있다.

## 2. 타겟 플랫폼 및 기술 (Platform & Tech)
- **Platform**: Android (우선 진행)
- **Auth**: Firebase Authentication (Phone/Email)
- **Backend Connection**: RESTful API (NestJS Server)

## 3. 상세 기능 목록 (Feature List)

### 3.1. 인증 및 회원 (Authentication)
| 기능 ID | 화면 ID | 기능명 | 상세 설명 및 로직 | 비고 |
| :--- | :--- | :--- | :--- | :--- |
| **M-AUTH-001** | V-SPLASH | **앱 실행/자동로그인** | • 앱 최초 실행 시 스플래시 화면 노출<br>• 기기에 저장된 토큰 유효성 확인 후 메인(V-HOME) 또는 로그인(V-LOGIN) 이동 | |
| **M-AUTH-002** | V-LOGIN | **로그인** | • 이메일/비밀번호 또는 소셜 로그인(Firebase)<br>• 로그인 성공 시 Access/Refresh Token 발급 및 저장 | |
| **M-AUTH-003** | V-SIGNUP | **회원가입** | • 약관 동의<br>• 휴대폰 번호 본인 인증 (Firebase Auth 연동)<br>• 필수 정보(이름, 생년월일, 성별) 입력<br>• **계정 통합 로직**: 입력한 전화번호가 `USERS` 테이블에 존재하고 `firebase_uid`가 NULL인 경우(기존 오프라인 고객), 신규 생성 대신 기존 레코드에 `firebase_uid`와 `email`을 업데이트하여 계정을 통합한다. | `firebase_uid` 매핑 (계정 통합) |
| **M-AUTH-004** | V-FIND | **계정 찾기** | • 등록된 휴대폰 번호로 이메일(ID) 찾기<br>• 비밀번호 재설정 (이메일 발송) | |

### 3.2. 메인 및 매장 (Home & Shop)
| 기능 ID | 화면 ID | 기능명 | 상세 설명 및 로직 | 비고 |
| :--- | :--- | :--- | :--- | :--- |
| **M-HOME-001** | V-HOME | **홈 대시보드** | • 다가오는 예약(D-Day) 카운트다운 표시<br>• 최근 방문한 매장/디자이너 바로가기<br>• 이벤트 배너 또는 공지사항 노출 | |
| **M-HOME-002** | V-SHOP | **매장 상세 정보** | • 매장 위치(지도), 영업 시간, 전화번호 조회<br>• 매장 소개 및 대표 이미지 슬라이드 | `SHOPS` 테이블 연동 |
| **M-HOME-003** | V-NOTI | **알림 함** | • 홈 화면 우측 상단 '종' 아이콘<br>• 예약 확정, 취소, 리마인드, 이벤트 등 지난 알림 이력 조회 | |

### 3.3. 예약 하기 (Reservation)
| 기능 ID | 화면 ID | 기능명 | 상세 설명 및 로직 | 비고 |
| :--- | :--- | :--- | :--- | :--- |
| **M-RES-001** | V-RES-STEP1 | **디자이너 선택** | • 해당 매장의 디자이너 목록 조회 (`is_active=true`)<br>• 디자이너 프로필 사진 및 소개글 확인<br>• '랜덤 배정(아무나)' 옵션 제공 가능 | `DESIGNERS` 테이블 |
| **M-RES-002** | V-RES-STEP2 | **시술 메뉴 선택** | • 카테고리별 시술 메뉴 리스트 조회<br>• 메뉴 선택 시 예상 소요시간 및 가격 합산 표시 | `MENUS` 테이블 |
| **M-RES-003** | V-RES-STEP3 | **날짜/시간 선택** | • 예약 가능한 날짜(캘린더) 및 시간(타임슬롯) 조회<br>• **중복 예약 방지**: 이미 예약된 시간(`RESERVATIONS`) 및 디자이너 휴무(`SCHEDULE_BLOCKS`) 제외 로직 적용 | |
| **M-RES-004** | V-RES-STEP4 | **예약 정보 확인** | • 선택한 디자이너, 일시, 메뉴, 금액 확인<br>• 요청 사항(Memo) 입력 | |
| **M-RES-005** | V-RES-PAY | **예약금 결제** | • 예약금(노쇼 방지) 결제 진행 (추후 PG 연동)<br>• 결제 완료/무통장 입금 확인 시 예약 상태 `CONFIRMED`로 저장 | `PAYMENTS` 테이블 |

### 3.4. 마이 페이지 (My Page)
| 기능 ID | 화면 ID | 기능명 | 상세 설명 및 로직 | 비고 |
| :--- | :--- | :--- | :--- | :--- |
| **M-MY-001** | V-MY-MAIN | **마이페이지 홈** | • 내 프로필 정보 요약<br>• 예약 내역 / 시술 히스토리 탭 구분 | |
| **M-MY-002** | V-MY-LIST | **예약 관리** | • **이용 예정**: 다가오는 예약 목록. 상세 클릭 시 예약 변경/취소 가능<br>• **취소 정책**: 예약 시간 1시간 전까지만 앱 취소 허용 (이후 매장 문의). 시점에 따른 예약금 환불 로직(전액/부분/불가) 적용.<br>• **이용 내역**: 지난 시술 내역, 결제 금액 조회 | `VISIT_LOGS` 연동 |
| **M-MY-003** | V-MY-INFO | **내 정보 수정** | • 프로필 사진, 연락처, 비밀번호 변경<br>• 회원 탈퇴 기능 | |
| **M-MY-004** | V-MY-SET | **설정** | • 푸시 알림(예약 알림, 마케팅) ON/OFF 설정 | `alarm_enabled` |

## 4. 데이터베이스 연동 사항 (DB Mapping)
- **USERS**: 모바일 앱 가입 시 `role='CUSTOMER'`, `is_app_user=true`로 저장
- **RESERVATIONS**: 예약 유입 경로 구분을 위해 `source` 컬럼 추가 (`enum: ADMIN, APP, NAVER, KAKAO`). 앱 예약 시 `source='APP'` 자동 설정하여 마케팅 성과 및 통계에 활용.
- **PAYMENTS**: 앱 결제 건은 `type='APP_DEPOSIT'`으로 기록하여 매출 관리 시 구분

## 5. 비고 (Remarks)
- 초기 버전(MVP)에서는 단일 매장을 가정하고 개발하되, 다중 매장 확장을 고려하여 `shop_id` 파라미터를 필수로 전달한다.
- 실시간 예약 동기화를 위해 예약 시간 선택 시 Server API를 통해 최신 가용 시간을 조회해야 한다.

## 6. 개발 참고 사항 (Development Notes)
> **개발 착수 전, 아래 기술적 디테일을 반드시 확인하세요.**

### 6.1. FCM 토큰 관리 (Push Notification)
- **목적**: `M-MY-004`(알림 설정) 및 `M-HOME-003`(알림함) 기능 구현을 위한 기기 식별.
- **필요 API**: `POST /users/device-token` (Body: `{ userId, fcmToken, platform: 'ANDROID' }`)
- **로직**:
    1. 로그인 성공 직후 및 앱 실행(Splash) 시점마다 FCM 토큰 확인.
    2. 변경 사항이 있거나 서버에 미등록된 경우 API 호출하여 갱신.

### 6.2. 강제 업데이트 기능 (Force Update)
- **목적**: 치명적인 버그 수정이나 API 변경 시, 구버전 앱 사용을 차단하여 에러 방지.
- **로직**:
    1. **Splash 화면(`M-AUTH-001`)** 진입 시 서버의 `Min-Version` API 호출.
    2. `User-App-Version < Server-Min-Version` 인 경우?
    3. "필수 업데이트가 필요합니다" 팝업 노출하고 스토어 링크로 이동 (앱 진입 차단).
